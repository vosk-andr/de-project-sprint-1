# Описание проекта
Проект представляет собой набор скриптов для создания и инкрементального обновления витрины данных в PostgreSQL.

**Архитектура системы:**
- **Компоненты** - PostgreSQL, SQL скрипты;
- **Назначение** - инкрементальное обновление витрины данных о заказчиках и их активности.

# Требования к витрине
**Основная таблица:**
- `customer_report_datamart` - витрина данных по заказчикам.

**Ключевые метрики:**
- Финансовые показатели: сумма расходов, доход платформы, средняя стоимость заказа;
- Аналитические показатели: популярная категория товаров, популярный мастер;
- Статистика по статусам заказов: созданные, в процессе, в доставке, завершенные;
- Временные метрики: медианное время выполнения заказа;
- Отчётный период (год-месяц).

# Источники данных
- **source1:**
  - `craft_market_wide` (широкая таблица).
- **source2:**
  - `craft_market_masters_products` (мастера и товары);
  - `craft_market_orders_customers` (заказы и заказчики).
- **source3:**
  - `craft_market_orders` (заказы и товары);
  - `craft_market_craftsmans` (мастера);
  - `craft_market_customers` (заказчики).
- **external_source:**
  - `craft_products_orders` (мастера, товары и заказы);
  - `customers` (заказчики).

# Процесс загрузки

## Шаг 1: Создание таблиц в слое DWH
**Файл:** `DDL_create_table.sql`.

Создает:
- **Таблицы измерений**: `d_craftsman`, `d_product`, `d_customer`;
- **Фактовая таблица**: `f_order`;
- **Витрина данных**: `customer_report_datamart`;
- **Таблица загрузок**: `load_dates_customer_report_datamart`.

## Шаг 2: Преобразование и загрузка данных
**Файл:** `SQL_add_external_source.sql`.

Процесс:
1. Приводит данные из источников к общему виду и объединяет во временную таблицу `tmp_sources`;
2. Инкрементально обновляет факты и измерения через оператор MERGE.

## Шаг 3: Обновление витрины
**Файл:** `SQL_update_customer_report_datamart.sql`.

Этапы инкрементального обновление через CTE:
1. `dwh_delta`- выявление изменённых данных;
2. `dwh_update_delta` - поиск заказчиков для обновления;
3. `dwh_delta_insert_result` - расчёт новых данных для вставки;
4. `dwh_delta_update_result` - перерасчёт существующих данных;
5. `insert_delta` - вставка новых записей;
6. `update_delta` - обновление существующих записей;
7. `insert_load_date` - фиксация времени загрузки.
